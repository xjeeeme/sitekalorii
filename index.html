<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Трекер Калорий и Веса</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap');

  /* Сброс */
  * {
    box-sizing: border-box;
    margin: 0; padding: 0;
  }

  body {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
      Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: #f5f5f7;
    color: #1d1d1f;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 16px 20px;
    background: #fff;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    border-bottom: 1px solid #d2d2d7;
    text-align: center;
    font-weight: 600;
    font-size: 24px;
    border-radius: 0 0 12px 12px;
  }

  main {
    flex-grow: 1;
    padding: 20px;
    max-width: 480px;
    margin: 0 auto;
    width: 100%;
  }

  nav {
    display: flex;
    justify-content: space-around;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    margin-bottom: 20px;
  }
  nav button {
    flex: 1;
    background: none;
    border: none;
    padding: 12px 0;
    font-weight: 600;
    font-size: 16px;
    color: #0071e3;
    cursor: pointer;
    border-radius: 12px 12px 0 0;
    transition: background-color 0.3s;
  }
  nav button.active, nav button:hover {
    background: #e5f0ff;
  }

  section {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.05);
  }

  h2 {
    margin-bottom: 12px;
    font-weight: 600;
  }

  /* Форма добавления продуктов */
  .product-form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .product-form input {
    flex: 1 1 120px;
    padding: 10px 14px;
    border: 1px solid #ccc;
    border-radius: 10px;
    font-size: 14px;
    outline-offset: 2px;
  }
  .product-form input::placeholder {
    color: #999;
  }
  .product-form button {
    padding: 10px 20px;
    background: #0071e3;
    border: none;
    color: #fff;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.25s;
  }
  .product-form button:hover {
    background: #005bb5;
  }

  /* Таблица продуктов */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
    margin-top: 15px;
  }
  th, td {
    text-align: left;
    padding: 8px 12px;
    font-size: 14px;
  }
  th {
    color: #6e6e73;
  }
  tbody tr {
    background: #f0f0f5;
    border-radius: 12px;
    transition: background-color 0.2s;
  }
  tbody tr:hover {
    background: #d8e3ff;
  }
  tbody tr td:first-child {
    border-radius: 12px 0 0 12px;
  }
  tbody tr td:last-child {
    border-radius: 0 12px 12px 0;
    text-align: center;
  }
  .delete-btn {
    background: #ff3b30;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 5px 9px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: background-color 0.2s;
  }
  .delete-btn:hover {
    background: #d32f2f;
  }

  /* Вес и цель */
  .weight-goal {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
  }
  .weight-goal input {
    flex: 1 1 150px;
    padding: 10px 14px;
    font-size: 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    outline-offset: 2px;
  }

  /* Итог */
  .summary {
    margin-top: 20px;
    font-weight: 600;
    font-size: 16px;
    color: #1d1d1f;
  }

  /* График веса */
  #weightChart {
    margin-top: 25px;
    max-width: 100%;
    height: 200px;
  }

  /* Адаптив для iPhone 13 mini */
  @media (max-width: 420px) {
    body {
      font-size: 15px;
    }
    nav button {
      font-size: 14px;
      padding: 10px 0;
    }
    .product-form input {
      flex: 1 1 100%;
    }
    .weight-goal input {
      flex: 1 1 100%;
    }
  }

</style>
</head>
<body>

<header>Трекер Калорий и Веса</header>

<main>
  <nav>
    <button id="tab-main" class="active">Главная</button>
    <button id="tab-stats">Статистика</button>
    <button id="tab-settings">Настройки</button>
  </nav>

  <section id="main-section">
    <h2>Добавить продукт</h2>
    <form id="productForm" class="product-form" autocomplete="off">
      <input type="text" id="productName" placeholder="Название продукта" required />
      <input type="number" id="productCalories" placeholder="Калории (ккал)" min="0" />
      <input type="number" id="productProtein" placeholder="Белки (г)" min="0" />
      <input type="number" id="productFat" placeholder="Жиры (г)" min="0" />
      <input type="number" id="productCarbs" placeholder="Углеводы (г)" min="0" />
      <button type="submit">Добавить</button>
    </form>

    <div class="summary" id="dailySummary">Сегодня: 0 ккал, 0 г белков, 0 г жиров, 0 г углеводов</div>

    <table id="productsTable" aria-label="Список продуктов">
      <thead>
        <tr>
          <th>Продукт</th>
          <th>Калории</th>
          <th>Белки</th>
          <th>Жиры</th>
          <th>Углеводы</th>
          <th>Удалить</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Вес и Цели</h2>
    <div class="weight-goal">
      <input type="number" id="currentWeight" placeholder="Текущий вес (кг)" min="0" />
      <input type="number" id="goalWeight" placeholder="Целевой вес (кг)" min="0" />
      <button id="saveWeightBtn">Сохранить</button>
    </div>
  </section>

  <section id="stats-section" style="display:none;">
    <h2>Статистика веса</h2>
    <canvas id="weightChart" aria-label="График веса" role="img"></canvas>
  </section>

  <section id="settings-section" style="display:none;">
    <h2>Настройки</h2>
    <p>Здесь можно добавить будущие настройки.</p>
    <p>Сейчас реализация минималистична.</p>
  </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Логика хранения данных ---

  // Ключи для localStorage
  const PRODUCTS_KEY = 'calorieTracker_products';
  const WEIGHT_KEY = 'calorieTracker_weight';

  // Получить дату в формате YYYY-MM-DD
  function getDateKey(date = new Date()) {
    return date.toISOString().split('T')[0];
  }

  // Загрузка продуктов за сегодня
  function loadProducts() {
    const allData = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '{}');
    const todayKey = getDateKey();
    return allData[todayKey] || [];
  }

  // Сохранение продуктов за сегодня
  function saveProducts(products) {
    const allData = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '{}');
    const todayKey = getDateKey();
    allData[todayKey] = products;
    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(allData));
  }

  // Загрузка веса и цели
  function loadWeight() {
    return JSON.parse(localStorage.getItem(WEIGHT_KEY) || '{"current":null,"goal":null,"history":{}}');
  }

  // Сохранение веса и цели
  function saveWeight(weightData) {
    localStorage.setItem(WEIGHT_KEY, JSON.stringify(weightData));
  }

  // Добавить запись веса в историю
  function addWeightHistory(dateKey, weight) {
    const weightData = loadWeight();
    weightData.history[dateKey] = weight;
    saveWeight(weightData);
  }

  // --- Обновление интерфейса ---

  const productForm = document.getElementById('productForm');
  const productsTableBody = document.querySelector('#productsTable tbody');
  const dailySummary = document.getElementById('dailySummary');
  const currentWeightInput = document.getElementById('currentWeight');
  const goalWeightInput = document.getElementById('goalWeight');
  const saveWeightBtn = document.getElementById('saveWeightBtn');

  let products = loadProducts();
  let weightData = loadWeight();

  function renderProducts() {
    productsTableBody.innerHTML = '';
    let sumCalories = 0, sumProtein = 0, sumFat = 0, sumCarbs = 0;

    products.forEach((p, idx) => {
      sumCalories += Number(p.calories) || 0;
      sumProtein += Number(p.protein) || 0;
      sumFat += Number(p.fat) || 0;
      sumCarbs += Number(p.carbs) || 0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.calories || '-'}</td>
        <td>${p.protein || '-'}</td>
        <td>${p.fat || '-'}</td>
        <td>${p.carbs || '-'}</td>
        <td><button class="delete-btn" data-idx="${idx}">×</button></td>
      `;
      productsTableBody.appendChild(tr);
    });

    dailySummary.textContent = `Сегодня: ${sumCalories} ккал, ${sumProtein} г белков, ${sumFat} г жиров, ${sumCarbs} г углеводов`;
  }

  // Удаление продукта
  productsTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('delete-btn')) {
      const idx = +e.target.dataset.idx;
      products.splice(idx, 1);
      saveProducts(products);
      renderProducts();
    }
  });

  // Добавление продукта
  productForm.addEventListener('submit', e => {
    e.preventDefault();
    const name = productForm.productName.value.trim();
    const calories = productForm.productCalories.value.trim();
    const protein = productForm.productProtein.value.trim();
    const fat = productForm.productFat.value.trim();
    const carbs = productForm.productCarbs.value.trim();

    if(!name) return;

    products.push({
      name,
      calories: calories ? Number(calories) : null,
      protein: protein ? Number(protein) : null,
      fat: fat ? Number(fat) : null,
      carbs: carbs ? Number(carbs) : null
    });

    saveProducts(products);
    renderProducts();

    productForm.reset();
  });

  // --- Вес и цели ---

  function renderWeight() {
    if(weightData.current !== null) currentWeightInput.value = weightData.current;
    if(weightData.goal !== null) goalWeightInput.value = weightData.goal;
  }

  saveWeightBtn.addEventListener('click', () => {
    const cur = Number(currentWeightInput.value);
    const goal = Number(goalWeightInput.value);
    if(cur > 0) {
      weightData.current = cur;
      weightData.goal = goal > 0 ? goal : null;
      addWeightHistory(getDateKey(), cur);
      saveWeight(weightData);
      renderWeight();
      renderWeightChart();
      alert('Вес и цели сохранены');
    } else {
      alert('Введите корректный текущий вес');
    }
  });

  // --- Таб переключения ---
  const tabs = {
    main: document.getElementById('main-section'),
    stats: document.getElementById('stats-section'),
    settings: document.getElementById('settings-section'),
  };
  const tabButtons = {
    main: document.getElementById('tab-main'),
    stats: document.getElementById('tab-stats'),
    settings: document.getElementById('tab-settings'),
  };

  function switchTab(tabName) {
    Object.entries(tabs).forEach(([key, section]) => {
      section.style.display = key === tabName ? 'block' : 'none';
    });
    Object.entries(tabButtons).forEach(([key, btn]) => {
      if(key === tabName) btn.classList.add('active');
      else btn.classList.remove('active');
    });
  }
  tabButtons.main.onclick = () => switchTab('main');
  tabButtons.stats.onclick = () => switchTab('stats');
  tabButtons.settings.onclick = () => switchTab('settings');

  // --- График веса ---

  const ctx = document.getElementById('weightChart').getContext('2d');
  let weightChart;

  function renderWeightChart() {
    const hist = weightData.history;
    const labels = Object.keys(hist).sort();
    const data = labels.map(d => hist[d]);

    if(weightChart) {
      weightChart.data.labels = labels;
      weightChart.data.datasets[0].data = data;
      weightChart.update();
    } else {
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Вес (кг)',
            data,
            borderColor: '#0071e3',
            backgroundColor: 'rgba(0,113,227,0.15)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7,
            borderWidth: 3,
            cubicInterpolationMode: 'monotone',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              suggestedMin: Math.min(...data) - 5,
              suggestedMax: Math.max(...data) + 5,
            }
          },
          plugins: {
            legend: {
              labels: {
                font: {
                  family: 'SF Pro Display',
                  size: 14,
                  weight: '600'
                },
                color: '#1d1d1f',
              }
            }
          }
        }
      });
    }
  }

  // --- Инициализация ---

  renderProducts();
  renderWeight();
  renderWeightChart();
  switchTab('main');

</script>

</body>
</html>
